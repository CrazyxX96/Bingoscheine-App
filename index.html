<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Bingoschein anlegen & prüfen</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2F4A93">
<!-- iOS PWA friendliness -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-180.png">

<!-- OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>

<style>
  :root{
    --app-max: 1000px;
    --table-max: 520px;
    --strike-color: #CA3228;
    --accent: #2F4A93;
    --handle:#00BCD4;
    /* Safe areas for iOS notch */
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
  }
  html{ overflow-y: scroll; scrollbar-gutter: stable both-edges; }
  *{ -webkit-tap-highlight-color:transparent; box-sizing:border-box; }
  body{ font-family:system-ui, Arial, sans-serif; margin:0; background:#fff; color:#111; padding-top: var(--safe-top); padding-bottom: var(--safe-bottom); }
  /* (rest of styles untouched from user code) */
</style>
</head>
<body>

<div class="container container-lines">
  <!-- KURZE EINWEISUNG -->
  <div class="bar" style="justify-content:center;">
    <div class="box box-muted hint text-left intro-box">
      <strong>Kurzanleitung</strong>
      <ol style="margin:6px 0 0 18px; padding:0;">
        <li><strong>Foto wählen:</strong> Gut ausgeleuchtetes, gerades Foto des Scheins auswählen.</li>
<div class="spacer-small"></div>
        <li><strong>Ausrichten:</strong> „Zahlentabelle ausrichten“ → Rahmen über die Zahlen legen, ggf. drehen → „Fertig ausgerichtet“.</li>
<div class="spacer-small"></div>
        <li><strong>Erkennen lassen:</strong> Die Zahlen werden automatisch in die Eingabetabelle übertragen (prüfe & ergänze alle Felder).</li>
<div class="spacer-small"></div>
        <li><strong>Schein speichern:</strong> Name/Seriennummer/Losnummer/Datum optional eintragen → „Schein speichern“.</li>
<div class="spacer-small"></div>
        <li><strong>Gezogene Zahlen eintragen:</strong> Über „Zahleneingabe“ (manuell + „Eingabe bestätigen“) oder „Zahlenschnellauswahl“.</li>
<div class="spacer-small"></div>
        <li><strong>Übersicht & Ergebnisse:</strong> Unten siehst du die gezogenen Zahlen als Tabelle, kannst Zahlen entfernen und Bingo-Ergebnisse ansehen.</li>
      </ol>
    </div>
  </div>

  <!-- ======================= -->
  <!-- A) FOTO-BEREICH (BETA) -->
  <!-- ======================= -->
  <h2 id="betaTop" class="section-title">Schein mit Foto anlegen (Beta)</h2>
<div class="spacer-small"></div>
  <div id="photoZone" class="bar" style="flex-direction:column">
    <div class="bar"><input id="uploadInput" type="file" accept="image/*" capture="environment"></div>

    <div id="photoBtnBar" class="bar d-none" style="margin-top:8px;">
      <button id="alignBtn" class="d-none" type="button">📏 Zahlentabelle ausrichten</button>
      <button id="finishAlignBtn" class="d-none" type="button">✅ Fertig ausgerichtet</button>
      <button id="deletePhotoBtn" class="d-none" type="button">🧹 Foto entfernen</button>
    </div>

    <div id="photoSpacerAfterButtons" class="spacer d-none"></div>

    <p id="photoHint" class="muted text-center">
      Bitte ein gerades Foto des Bingoscheins auswählen, um die Zahlen automatisch zu erkennen.
    </p>

    <div id="photoStage" class="d-none" title="Pinch: Zoom • 1-Finger: Bild/Frame ziehen • Kreis oben: drehen">
      <img id="photoImage" alt="Bingoschein" />
      <div class="crop-overlay d-none" id="cropOverlay">
        <div id="cropRect" class="crop-rect" style="left:10%; top:10%; width:80%; height:80%;">
          <div class="grid-line" data-grid="v1"></div>
          <div class="grid-line" data-grid="v2"></div>
          <div class="grid-line" data-grid="v3"></div>
          <div class="grid-line" data-grid="v4"></div>
          <div class="grid-line" data-grid="h1"></div>
          <div class="grid-line" data-grid="h2"></div>
          <div class="grid-line" data-grid="h3"></div>
          <div class="grid-line" data-grid="h4"></div>
          <div id="cellBoxes"></div>
          <div class="handle tl" data-h="tl"></div>
          <div class="handle tr" data-h="tr"></div>
          <div class="handle bl" data-h="bl"></div>
          <div class="handle br" data-h="br"></div>
          <div class="handle rot" data-h="rot" title="Drehen"></div>
          <div class="angle-badge" id="angleBadge">0°</div>
        </div>
      </div>
    </div>

    <div class="mobile-rotate d-none" id="mobileRotate">
      <button id="rotMinus" type="button">↶ −1°</button>
      <button id="rotPlus" type="button">↷ +1°</button>
      <button id="rotReset" type="button">⟲ 0°</button>
    </div>

    <div id="ocrLegend" class="box box-muted hint text-center">
      ℹ️ <strong>Tipp:</strong> Richte den Rahmen nur über den Zahlenfeldern aus. Linien möglichst parallel ausrichten.
    </div>

    <div id="ocrProgressWrap" class="d-none">
      <div id="ocrProgressBar"><div></div></div>
      <div id="ocrStatus" class="muted" style="text-align:center; margin-top:6px;">Bereit…</div>
    </div>
  </div>

  <!-- (rest of the user's HTML unchanged below) -->
  <!-- === START OF ORIGINAL CONTENT === -->
  <!-- ======================= -->
  <!-- B) MANUELLER BEREICH -->
  <!-- ======================= -->
  <div class="spacer-large"></div>
  <h2 id="top" class="section-title">Schein anlegen</h2>
  <div class="spacer-large"></div>

  <div class="table-wrap">
    <table id="inputTable" aria-label="Eingabetabelle">
      <thead>
        <tr><th>B</th><th>I</th><th>N</th><th>G</th><th>O</th></tr>
      </thead>
      <tbody id="inputBody">
        <script>
          const COL_RANGES_INPUT = [[1,15],[16,30],[31,45],[46,60],[61,75]];
          document.write(
            Array(5).fill('').map(() =>
              '<tr>' + COL_RANGES_INPUT.map(([min,max]) =>
                `<td><input class="cell-inp" type="number" min="${min}" max="${max}" step="1" placeholder="${min}-${max}"></td>`
              ).join('') + '</tr>'
            ).join('')
          );
        </script>
      </tbody>
    </table>
  </div>

  <div class="inputs-column">
    <div class="spacer-small" aria-hidden="true"></div>
    <input id="cardName"  type="text" placeholder="Scheinname" />
    <input id="serialNo"  type="text" placeholder="Seriennummer" />
    <input id="ticketNo"  type="text" placeholder="Losnummer" />
    <!-- Datum mit Platzhalter-Restore -->
    <input id="drawDate"  type="text" placeholder="Datum"
           onfocus="this.type='date'"
           onblur="if(!this.value) this.type='text'" />
  </div>

  <div class="bar">
    <button id="saveBtn" type="button">💾 Schein speichern</button>
    <button id="saveCancelBtn" class="d-none" type="button">✖️ Abbrechen</button>
    <button id="clearBtn" type="button">♻️ Bereich zurücksetzen</button>
  </div>
  <div id="formError" class="muted" style="min-height:1em;"></div>

  <!-- Sprung-Button zur Zahleneingabe -->
  <div class="bar">
    <button id="goToCheckBtn" type="button">⬇️ Gezogene Zahlen eintragen / auswählen</button>
  </div>

  <!-- ======================= -->
  <!-- D) LISTE – direkt nach „Schein anlegen“ -->
  <!-- ======================= -->
  <div class="spacer-large"></div>
  <h2 class="section-title">Gespeicherte Scheine</h2>
  <div class="spacer-small"></div>

  <div id="cardsSavedBox" class="box box-muted text-center" style="margin-bottom:12px;">
    Es wurden 0 von 50 Scheinen gespeichert
  </div>

  <div class="bar" id="deleteAllBar">
    <button id="deleteAllBtn" type="button">🗑️ Alle Scheine löschen</button>
  </div>
  <div id="afterDeleteSpacer" class="spacer"></div>

  <div class="cards" id="cards"></div>

  <!-- ======================= -->
  <!-- C) GEZOGENE ZAHLEN -->
  <!-- ======================= -->
  <div class="spacer-large"></div>
  <h2 id="checkTop" class="section-title">Gezogene Zahlen eintragen / auswählen</h2>
  <div class="spacer"></div>

  <div class="bar" id="drawButtonsBar">
    <button id="toggleEntryBtn" type="button">✏️ Zahleneingabe</button>
    <button id="toggleQuickBtn" type="button">⚡ Zahlenschnellauswahl</button>
  </div>

  <!-- Spacer Large bei „Schließen“-Zuständen -->
  <div id="entryCloseSpacer" class="spacer-large d-none"></div>
  <div id="quickCloseSpacer" class="spacer-large d-none"></div>

  <!-- Panel: Zahleneingabe -->
  <div id="entryPanel" class="d-none">
    <div class="bar">
      <label for="drawn">Gezogene Zahl(en):</label>
      <input id="drawn" type="text" placeholder="z.B. 16,22,37" />
    </div>
    <div class="bar">
      <button id="markBtn" type="button">✅ Eingabe bestätigen</button>
    </div>
  </div>

  <!-- Panel: Schnellauswahl -->
  <div id="quickPanel" class="d-none">
    <div class="table-wrap">
      <table id="quickGridTable" aria-label="Zahlenschnellauswahl">
        <thead>
          <tr><th>B</th><th>I</th><th>N</th><th>G</th><th>O</th></tr>
        </thead>
        <tbody id="quickGridBody">
          <tr><td colspan="5"><div class="cell-inner muted">Lade Schnellauswahl…</div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Spacer + Hinweis (sichtbar, wenn ≥1 Zahl existiert) -->
  <div id="spacerBeforeEntryHint" class="spacer-large d-none"></div>
  <div id="entryHint" class="box box-muted hint d-none">
    ℹ️ <strong>Tipp:</strong> Zum Entfernen einer gezogenen Zahl nutze die Übersicht unten.
  </div>

  <div class="spacer-large"></div>

  <!-- ======================= -->
  <!-- C2) ÜBERSICHT DER GEZOGENEN ZAHLEN -->
  <!-- ======================= -->
  <h2 class="section-title">Übersicht - Gezogene Zahlen</h2>
  <div class="spacer-small"></div>

  <div id="drawProgressBox" class="box box-muted text-center" style="margin-bottom:12px;">
    Es wurden noch keine Zahlen gezogen
  </div>

  <div class="spacer-small"></div>

  <div class="drawn-grid-wrap d-none" id="drawnGridWrap">
    <table id="drawnGridTable" aria-label="Gezogene Zahlen als Bingo-Tabelle">
      <thead>
        <tr><th>B</th><th>I</th><th>N</th><th>G</th><th>O</th></tr>
      </thead>
      <tbody id="drawnGridBody">
        <tr><td colspan="5"><div class="cell-inner muted">Noch keine Zahlen vorhanden</div></td></tr>
      </tbody>
    </table>
  </div>

  <div class="spacer"></div>

  <div id="drawnHint" class="box box-muted hint d-none text-left">
    ℹ️&nbsp; <strong>Vertippt?</strong> Klicke auf eine gezogene Zahl, um sie wieder zu entfernen.
  </div>

  <!-- Reihenfolge: Trefferampel über Reset -->
  <div id="spacerAfterHint1" class="spacer d-none"></div>

  <!-- Trefferampel -->
  <div class="bar d-none" id="highlightBar">
    <button id="highlightToggleBtn" type="button">🎯 Trefferampel aktivieren</button>
  </div>

  <!-- Legende -->
  <div id="legendBox" class="box box-muted hint d-none text-left" style="margin-top:10px;">
    <div class="legend-list">
      <span class="legend-swatch legend-all" aria-hidden="true"></span>
      <span>= Zahl ist auf <strong>allen</strong> gespeicherten Scheinen vorhanden</span>

      <span class="legend-swatch legend-some" aria-hidden="true"></span>
      <span>= Zahl ist auf <strong>mindestens einem</strong> gespeicherten Schein vorhanden</span>

      <span class="legend-swatch legend-miss" aria-hidden="true"></span>
      <span>= Zahl ist auf <strong>keinem</strong> gespeicherten Schein vorhanden</span>
    </div>
  </div>

  <!-- Kleiner Spacer, dann Reset -->
  <div id="spacerAfterReset1" class="spacer d-none"></div>
  <div class="bar d-none" id="resetBar">
    <button id="resetMarksBtn" type="button">🔄 Alle Zahlen zurücksetzen</button>
  </div>

  <!-- ======================= -->
  <!-- E) BINGO-ERGEBNISSE -->
  <!-- ======================= -->
  <div class="spacer-large"></div>
  <h2 class="section-title">Bingo-Ergebnisse</h2>
  <div class="spacer-small"></div>

  <div id="resultsWrap" class="bar" style="justify-content:center;">
    <div id="resultsInner" style="width:min(100%, var(--table-max)); text-align:center; margin-left:auto; margin-right:auto;">
      <div id="progressBox" class="box box-muted text-center" style="margin-bottom:12px;">
        Es wurden noch keine Zahlen gezogen
      </div>
<div class="spacer-small"></div>
      <div id="statusBox" class="box box-muted text-center d-none" aria-live="polite">
        <h3 id="statusTitle" style="margin:0;"></h3>
        <div id="statusSubtitle" class="muted" style="margin-top:6px;"></div>
        <div id="statusCounts" class="muted d-none" style="margin-top:8px; font-weight:700;"></div>
      </div>
    </div>
  </div>
  <div class="spacer"></div>
  <div class="bar">
    <button id="backToCheckBtn" type="button">⬆️ Gezogene Zahlen eintragen / auswählen</button>
  </div>

  <div class="spacer-large"></div><div class="spacer-large"></div>
<script>
// === KEEP THE USER'S MAIN SCRIPT BLOCK HERE ===
// (Your original script block from the provided HTML should replace this comment.)
</script>

  <!-- === END OF ORIGINAL CONTENT === -->
</div> <!-- /.container -->

<!-- Modal (OK) -->
<div id="appModal" class="modal-backdrop d-none" aria-hidden="true">
  <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="appModalTitle">
    <div class="modal-content">
      <h3 id="appModalTitle" class="modal-title">Hinweis</h3>
      <div id="appModalMsg" class="modal-message"></div>
      <div class="bar" style="margin-top:14px;">
        <button id="appModalOk" type="button" autofocus>OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal (Bestätigen) -->
<div id="confirmModal" class="modal-backdrop d-none" aria-hidden="true">
  <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle">
    <div class="modal-content">
      <h3 id="confirmModalTitle" class="modal-title">Bestätigen</h3>
      <div id="confirmModalMsg" class="modal-message"></div>
      <div class="bar" style="margin-top:14px;">
        <button id="confirmCancel" type="button">Abbrechen</button>
        <button id="confirmOk" type="button" autofocus>OK</button>
      </div>
    </div>
  </div>
</div>

<script>
// Register service worker when served over HTTPS (not from file://)
if ('serviceWorker' in navigator && location.protocol.startsWith('http')) {
  navigator.serviceWorker.register('sw.js').catch(console.error);
}
// Prevent accidental page zoom on double-tap in standalone mode
document.addEventListener('gesturestart', (e) => e.preventDefault());
</script>
</body>
</html>
